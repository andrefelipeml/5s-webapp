<div class="button-page">
  <div class="row">
    <div class="col-sm-12">
      <app-card [title]="'Cadastro de Auditorias'">
        <form #auditForm="ngForm" (submit)="save(audit);">
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Título</label>
            <div class="col-sm-10">
              <input [(ngModel)]="audit.title" required name="title" #title="ngModel" type="text" class="form-control">
              <span *ngIf="title.invalid && (title.dirty || title.touched)" style='color: red'>Este campo é obrigatório.</span>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Unidade</label>
            <div class="col-sm-10">
              <select [(ngModel)]="audit.units_id" #auditUnit="ngModel" required name="auditUnit" (change)="loadEnviromentsByUnit($event.target.value)"
                class="form-control">
                <option disabled *ngIf="units?.length == 0">Nenhuma unidade cadastrada.</option>
                <option *ngFor="let unit of units" [value]="unit.id">
                  {{ unit.name }}
                </option>
              </select>
              <span *ngIf="auditUnit.invalid && (auditUnit.dirty || auditUnit.touched)" style='color: red'>Este campo é obrigatório.</span>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Ambiente(s)</label>
            <div class="col-sm-10">
              <ng-select 
                #environments="ngModel"
                [options]="selectItems"
                name="selectItems"
                [multiple]="isMultiple"
                notFoundMsg="Nenhum ambiente cadastrado."
                [(ngModel)]="selectedEnviroment"
                required>
              </ng-select>
            </div>
          </div>

          <div class="row">
            <label class="col-sm-2 col-form-label">Período</label>
            <div class="col-xs-12 col-12 col-sm-6 col-md-4 form-group">
              <input class="form-control" bsDaterangepicker name="period" [bsConfig]="{rangeInputFormat: 'DD/MM/YYYY', locale: 'pt-br'}"
                #drp="bsDaterangepicker" [(ngModel)]="period" onkeydown="return false">
            </div>
            <div class="col-xs-12 col-12 col-md-3 form-group">
              <button type="button" class="btn btn-success" (click)="drp.toggle()" [attr.aria-expanded]="drp.isOpen">
                <i class='far fa-calendar-alt'></i>
              </button>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Avaliador</label>
            <div class="col-sm-10">
              <select [(ngModel)]="evaluation.users_id" #appraiser="ngModel" required name="appraiser" class="form-control">
                <option *ngFor="let user of users" [value]="user.id">
                  {{ user.name }}
                </option>
              </select>
              <span *ngIf="appraiser.invalid && (appraiser.dirty || appraiser.touched)" style='color: red'>Este campo é obrigatório.</span>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Descrição <span class="optional-value">(Opcional)</span></label>
            <div class="col-sm-10">
              <textarea [(ngModel)]="audit.description" class="textarea-width-100 form-control" name="comment"></textarea>
            </div>
          </div>

          <button class="btn btn-primary pull-right no-margin-right" [disabled]="!auditForm.valid" type="submit">Salvar</button>
        </form>
      </app-card>

      <ng-template #noAudits>
        <p class="no-content">Nenhum registro para mostrar.</p>
      </ng-template>

      <app-card [title]="'Listagem de Auditorias'">
        <div class="row">
          <h4 class="col-sm-2">Pesquisar: </h4>
          <input class="form-control col-sm-10" #auditSearch placeholder="Pesquise por uma auditoria" (keyup)="findAudits(auditSearch.value)">
        </div>
        <div class="table-responsive">
          <table *ngIf="audits?.length > 0; else noAudits" class="table table--clean">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Avaliador</th>
                <th>Ambiente(s)</th>
                <th>Status</th>
                <th>Data Inicial</th>
                <th>Data Final</th>
                <th>Descrição</th>
                <th>Ações</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let audit of auditFiltered">
                <td>{{audit.title}}</td>
                <td>{{audit.user_name}}</td>
                <td>{{audit.enviroment_name}}</td>
                <td>{{audit.status == 0 ? 'Pendente' : 'Concluída'}}</td>
                <td>{{audit.initial_date | date: 'dd/MM/yyyy' }}</td>
                <td>{{audit.due_date | date: 'dd/MM/yyyy' }}</td>
                <td>{{audit.description}}</td>
                <td> 
                  <span class="inline-block">
                    <button class="btn btn-info btn-icon no-margin" [disabled]="audit.status === 'CONCLUIDA'" (click)="update(audit)">
                      <i class="icofont icofont-edit" title="Você não pode editar uma auditoria concluida"></i>
                    </button>
                  </span>
                  <span class="inline-block margin-left-10">
                    <button class="btn btn-danger btn-icon no-margin" [disabled]="audit.status === 'CONCLUIDA'" (click)="getModalAnswer(audit.id)">
                      <i class="icofont icofont-trash" title="Você não pode remover uma auditoria concluida"></i>
                    </button>
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
          <div class="noContents" *ngIf="lengthAuditsPagination > 10">
            <pagination [totalItems]="lengthAuditsPagination" (pageChanged)="pageChanged($event)"></pagination>
          </div>
        </div>
      </app-card>
    </div>
  </div>
</div>